FROM node:18-slim

WORKDIR /app

# install python and exiftool
RUN apt-get update && \
    apt-get install -y python3 python3-pip python3-venv exiftool && \
    rm -rf /var/lib/apt/lists/*

# create a virtual environment for python packages
RUN python3 -m venv /opt/venv
ENV PATH="/opt/venv/bin:$PATH"

# install python dependencies
RUN pip install --no-cache-dir opencv-python-headless numpy

# copy python scripts
COPY find_and_merge_aeb.py process_uploads.py hdr_utils.py ./

# copy frontend
COPY frontend/package.json frontend/package-lock.json ./frontend/
RUN cd frontend && npm install
COPY frontend ./frontend

WORKDIR /app/frontend
RUN npm run build

EXPOSE 3000
CMD ["npm", "start"]
